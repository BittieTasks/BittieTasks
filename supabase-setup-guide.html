<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Authentication Setup Guide</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .step {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .step h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .code {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .warning {
            background: rgba(255,255,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffeb3b;
            margin: 15px 0;
        }
        .success {
            background: rgba(0,255,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            margin: 15px 0;
        }
        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .test-result {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Supabase Authentication Setup</h1>
        <p>Complete configuration for BittieTasks email verification and authentication</p>
        
        <div class="success">
            <h3>‚úÖ Current Status</h3>
            <p><strong>Project:</strong> ttgbotlcbzmmyqawnjpj.supabase.co</p>
            <p><strong>API Key:</strong> Configured and working</p>
            <p><strong>Connection:</strong> Active</p>
        </div>

        <div class="step">
            <h3>Step 1: Configure Email Templates</h3>
            <p>In your Supabase Dashboard:</p>
            <ol>
                <li>Go to <strong>Authentication ‚Üí Email Templates</strong></li>
                <li>Configure the <strong>Confirm signup</strong> template</li>
                <li>Set the redirect URL to: <code>https://your-domain.replit.dev/auth</code></li>
            </ol>
            
            <div class="warning">
                <strong>Important:</strong> The redirect URL must match your Replit domain exactly.
            </div>
        </div>

        <div class="step">
            <h3>Step 2: SMTP Configuration</h3>
            <p>Since you have SendGrid, configure SMTP in Supabase:</p>
            <ol>
                <li>Go to <strong>Settings ‚Üí Auth</strong></li>
                <li>Scroll to <strong>SMTP Settings</strong></li>
                <li>Enable custom SMTP</li>
                <li>Configure SendGrid SMTP:</li>
            </ol>
            
            <div class="code">SMTP Host: smtp.sendgrid.net
SMTP Port: 587
SMTP User: apikey
SMTP Pass: [Your SendGrid API Key]
Sender Name: BittieTasks
Sender Email: noreply@bittietasks.com</div>
            
            <div class="warning">
                <strong>Note:</strong> You'll need a verified sender identity in SendGrid for the sender email.
            </div>
        </div>

        <div class="step">
            <h3>Step 3: Authentication Settings</h3>
            <p>Configure these settings in <strong>Authentication ‚Üí Settings</strong>:</p>
            
            <div class="code">‚úÖ Enable email confirmations: ON
‚úÖ Enable email change confirmations: ON
‚úÖ Enable secure email change: ON
‚úÖ Double confirm email changes: ON

Site URL: https://your-domain.replit.dev
Additional redirect URLs:
- https://your-domain.replit.dev/auth
- https://your-domain.replit.dev/platform</div>
        </div>

        <div class="step">
            <h3>Step 4: Test Current Setup</h3>
            <p>Let's test your current Supabase configuration:</p>
            
            <button onclick="testSupabaseConnection()">Test Connection</button>
            <button onclick="testAuthSettings()">Test Auth Settings</button>
            <button onclick="testEmailFlow()">Test Email Flow</button>
            
            <div id="testResults" class="test-result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>Step 5: Quick Fix Options</h3>
            <p>If email verification is still not working:</p>
            
            <button onclick="disableEmailVerification()">Disable Email Verification (Dev Only)</button>
            <button onclick="enableManualConfirmation()">Enable Manual Confirmation</button>
            
            <div class="warning">
                <strong>Development Tip:</strong> You can temporarily disable email confirmation for development and re-enable it for production.
            </div>
        </div>

        <div class="step">
            <h3>Step 6: Alternative Solutions</h3>
            <p>If you prefer to skip Supabase email for now:</p>
            
            <ol>
                <li><strong>Option A:</strong> Use direct SendGrid integration for emails</li>
                <li><strong>Option B:</strong> Implement custom verification system</li>
                <li><strong>Option C:</strong> Use development bypass until production</li>
            </ol>
            
            <button onclick="implementCustomAuth()">Implement Custom Email System</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabase = createClient(
            'https://ttgbotlcbzmmyqawnjpj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Z2JvdGxjYnptbXlxYXduanBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MDA4NzksImV4cCI6MjA3MDE3Njg3OX0.jc_PZay5gUyleINrGC5d5Sd2mCkHjonP56KCLJJNM1k'
        );
        
        const results = document.getElementById('testResults');
        
        window.testSupabaseConnection = async () => {
            results.style.display = 'block';
            results.textContent = 'Testing Supabase connection...';
            
            try {
                const { data, error } = await supabase.auth.getSession();
                
                const connectionTest = {
                    connected: !error,
                    error: error?.message,
                    timestamp: new Date().toISOString(),
                    projectUrl: 'https://ttgbotlcbzmmyqawnjpj.supabase.co',
                    status: 'Connection successful'
                };
                
                results.textContent = JSON.stringify(connectionTest, null, 2);
                
            } catch (error) {
                results.textContent = `Connection failed: ${error.message}`;
            }
        };
        
        window.testAuthSettings = async () => {
            results.style.display = 'block';
            results.textContent = 'Testing authentication settings...';
            
            try {
                // Test sign up to see response
                const testEmail = `test+${Date.now()}@example.com`;
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: 'testpassword123'
                });
                
                const authTest = {
                    signUpWorking: !error,
                    error: error?.message,
                    userCreated: !!data?.user,
                    sessionCreated: !!data?.session,
                    emailConfirmationRequired: !data?.session && !!data?.user,
                    settings: {
                        requiresEmailConfirmation: !data?.session,
                        autoConfirm: !!data?.session
                    }
                };
                
                results.textContent = JSON.stringify(authTest, null, 2);
                
            } catch (error) {
                results.textContent = `Auth test failed: ${error.message}`;
            }
        };
        
        window.testEmailFlow = async () => {
            results.style.display = 'block';
            results.textContent = 'Testing email flow...';
            
            try {
                const response = await fetch('/api/send-test-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@example.com' })
                });
                
                const emailTest = await response.json();
                results.textContent = `Email Test Results:\n${JSON.stringify(emailTest, null, 2)}`;
                
            } catch (error) {
                results.textContent = `Email test failed: ${error.message}`;
            }
        };
        
        window.disableEmailVerification = () => {
            results.style.display = 'block';
            results.textContent = `To disable email verification in Supabase:

1. Go to Authentication ‚Üí Settings
2. Turn OFF "Enable email confirmations"
3. Save settings

This will allow immediate sign-in without email verification.
Remember to re-enable for production!`;
        };
        
        window.enableManualConfirmation = () => {
            results.style.display = 'block';
            results.textContent = `Manual confirmation options:

1. Use Supabase Dashboard ‚Üí Authentication ‚Üí Users
2. Manually confirm users by clicking "Confirm email"
3. Or use the service role key to confirm programmatically

This gives you control over who gets access.`;
        };
        
        window.implementCustomAuth = () => {
            alert('Custom authentication system would:\n\n1. Use Supabase for user storage\n2. Send emails directly via SendGrid\n3. Handle verification tokens manually\n4. Provide complete control over the flow\n\nWould you like me to implement this?');
        };
    </script>
</body>
</html>